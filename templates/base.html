{% load static %}
<!DOCTYPE html>
<html lang="ja" data-theme="">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KokkoSofter</title>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.7.2/dist/full.min.css" rel="stylesheet" type="text/css" />
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- KokkoSofter カスタムCSS -->
  <link rel="stylesheet" href="{% static 'css/main.css' %}" />
  
  <!-- ページ初期表示制御（フラッシュ防止） -->
  <script>
    document.documentElement.style.visibility = 'hidden';
    document.documentElement.style.opacity = '0';
    
    window.addEventListener('DOMContentLoaded', function() {
      document.documentElement.style.transition = 'opacity 0.1s ease-out';
      document.documentElement.style.visibility = 'visible';
      document.documentElement.style.opacity = '1';
      document.body.style.visibility = 'visible';
      document.body.style.opacity = '1';
      // サイドバー初期状態（モバイル時は非表示、PC時は表示）
      var sidebar = document.getElementById('mobile-sidebar');
      if(window.innerWidth < 768) {
        if(sidebar) sidebar.classList.remove('block');
        if(sidebar) sidebar.classList.add('hidden');
      } else {
        if(sidebar) sidebar.classList.remove('hidden');
        if(sidebar) sidebar.classList.add('block');
      }
    });
  </script>
</head>

<body class="bg-base-200 min-h-screen text-base-content" style="visibility:hidden;opacity:0;">

  <!-- デスクトップヘッダー -->
  <header class="navbar bg-base-200 px-4 hidden md:flex">
    <div class="flex-1">
      <a href="/" class="inline-block transition-link">
        <img id="logo-image" src="{% static 'images/logo.png' %}" alt="KokkoSofter" class="h-12" />
      </a>
      {% if user.is_authenticated %}
        <label for="modal-post" class="btn btn-sm btn-primary h-8 ml-2">📝 投稿</label>
        <div class="ml-4 flex items-center space-x-2">
          <span>こんにちは！{{ user.username }} さん</span>
          <span class="badge {{ user.profile.get_role_badge_class }} badge-xs role-badge">
            {{ user.profile.get_role_display_with_icon }}
          </span>
        </div>
      {% else %}
        <label for="modal-login" class="btn btn-sm btn-primary h-8 ml-2">ログイン</label>
      {% endif %}
    </div>
    <div class="flex-none gap-2">
      <label class="swap swap-rotate cursor-pointer">
        <input type="checkbox" id="theme-toggle" class="theme-controller" />
        <!-- 太陽アイコン (ライトモード時表示) -->
        <svg class="swap-off fill-current w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M5.64,17l-.71.71a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71A1,1,0,0,0,5.64,17ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm7-7a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41l-.71-.71A1,1,0,0,0,4.93,6.34Zm12,.29a1,1,0,0,0,.7-.29l.71-.71a1,1,0,1,0-1.41-1.41L17,5.64a1,1,0,0,0,0,1.41A1,1,0,0,0,17.66,7.34ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-9,8a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19ZM18.36,17A1,1,0,0,0,17,18.36l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM12,6.5A5.5,5.5,0,1,0,17.5,12,5.51,5.51,0,0,0,12,6.5Zm0,9A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/>
        </svg>
        <!-- 月アイコン (ダークモード時表示) -->
        <svg class="swap-on fill-current w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"/>
        </svg>
      </label>
      {% if user.is_authenticated %}
        <a href="{% url 'accounts:profile_settings' %}" class="avatar cursor-pointer group relative transition-link">
          <div class="w-8 rounded-full ring-2 ring-primary/30 ring-offset-2 ring-offset-base-100 group-hover:ring-primary transition-all duration-200 hover:scale-110">
            <img src="{{ user.profile.get_avatar_url }}" alt="{{ user.username }}アイコン" class="rounded-full" />
          </div>
          <!-- ホバー時のツールチップ -->
          <div class="absolute top-12 right-0 z-[200] invisible group-hover:visible opacity-0 group-hover:opacity-100 transition-all duration-200 transform translate-y-2 group-hover:translate-y-0">
            <div class="bg-base-100 rounded-lg shadow-lg p-3 min-w-[150px] border border-base-content/10">
              <p class="text-sm font-medium">{{ user.username }}</p>
              <div class="flex items-center justify-between mt-2">
                <span class="badge {{ user.profile.get_role_badge_class }} badge-xs role-badge">
                  {{ user.profile.get_role_display_with_icon }}
                </span>
              </div>
              <p class="text-xs text-base-content/60 mt-1">アカウント設定</p>
            </div>
            <!-- 三角形の矢印 -->
            <div class="absolute right-4 -top-2 w-4 h-4 bg-base-100 border-l border-t border-base-content/10 transform rotate-45"></div>
          </div>
        </a>
      {% else %}
        <div class="avatar">
          <div class="w-8 rounded-full">
            <img src="https://i.pravatar.cc/100" />
          </div>
        </div>
      {% endif %}
    </div>
  </header>

  <!-- モバイルヘッダー -->
  <header class="navbar bg-base-200 px-4 flex md:hidden">
    <div class="flex-none">
      {% if user.is_authenticated %}
      <button id="mobile-menu-btn" class="btn btn-square btn-ghost">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
      {% endif %}
    </div>
    <div class="flex-1 flex justify-center">
      <a href="/" class="inline-block transition-link">
        <img id="mobile-logo-image" src="{% static 'images/logo.png' %}" alt="KokkoSofter" class="h-10" />
      </a>
    </div>
    <div class="flex-none gap-2">
      <label class="swap swap-rotate cursor-pointer">
        <input type="checkbox" id="mobile-theme-toggle" class="theme-controller" />
        <!-- 太陽アイコン -->
        <svg class="swap-off fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M5.64,17l-.71.71a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71A1,1,0,0,0,5.64,17ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm7-7a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41l-.71-.71A1,1,0,0,0,4.93,6.34Zm12,.29a1,1,0,0,0,.7-.29l.71-.71a1,1,0,1,0-1.41-1.41L17,5.64a1,1,0,0,0,0,1.41A1,1,0,0,0,17.66,7.34ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-9,8a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19ZM18.36,17A1,1,0,0,0,17,18.36l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM12,6.5A5.5,5.5,0,1,0,17.5,12,5.51,5.51,0,0,0,12,6.5Zm0,9A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/>
        </svg>
        <!-- 月アイコン -->
        <svg class="swap-on fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"/>
        </svg>
      </label>
      {% if user.is_authenticated %}
        <a href="{% url 'accounts:profile_settings' %}" class="avatar cursor-pointer transition-link">
          <div class="w-8 rounded-full">
            <img src="{{ user.profile.get_avatar_url }}" alt="{{ user.username }}のアイコン" class="rounded-full" />
          </div>
        </a>
      {% else %}
        <label for="modal-login" class="btn btn-sm btn-primary">ログイン</label>
      {% endif %}
    </div>
  </header>

  <!-- モバイル用サイドバーバックドロップ -->
  <div id="sidebar-backdrop" class="mobile-backdrop"></div>

  <!-- ページ遷移ローディング -->
  <div id="transition-overlay" class="transition-overlay">
    <div class="loading-content">
      <span class="loading loading-spinner loading-lg text-white"></span>
      <p class="text-sm font-medium mt-4">読み込み中...</p>
    </div>
  </div>

  <div class="flex flex-col md:flex-row min-h-screen bg-base-200 relative page-content md:gap-4" id="page-content">

    {% if user.is_authenticated %}
    <!-- サイドバー（ログイン時のみ表示） -->
    <aside id="mobile-sidebar" data-sidebar="left"
      class="bg-base-300 p-3 rounded-lg shadow-lg sidebar-sticky sidebar-left sidebar-full-height md:block" style="min-width: 280px; max-width: 280px; width: 280px;">
      <div class="h-full flex flex-col">
      <!-- モバイル用クローズボタン -->
      <div class="flex justify-between items-center md:hidden mb-4 flex-shrink-0">
        <h2 class="text-sm font-semibold truncate flex-1">メニュー</h2>
        <button id="mobile-close-btn" class="btn btn-square btn-ghost btn-sm flex-shrink-0">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      {% if user.is_authenticated %}
        <!-- アカウント情報 -->
        <div class="mb-4 p-3 bg-base-100 rounded-lg overflow-hidden">
          <div class="flex items-center space-x-3 mb-3">
            <div class="avatar flex-shrink-0">
              <div class="w-10 rounded-full">
                <img src="{{ user.profile.get_avatar_url }}" alt="{{ user.username }}" />
              </div>
            </div>
            <div class="flex-1 min-w-0 overflow-hidden">
              <p class="font-semibold truncate text-sm">{{ user.username }}</p>
              <span class="badge {{ user.profile.get_role_badge_class }} badge-xs role-badge">
                {{ user.profile.get_role_display_with_icon }}
              </span>
            </div>
          </div>
          <div class="space-y-1">
            <a href="{% url 'accounts:profile_settings' %}" class="btn btn-xs btn-outline w-full transition-link truncate text-xs">
              ⚙️ アカウント設定
            </a>
            {% if user.is_staff or user.is_superuser or user.profile.can_manage_users %}
            <a href="{% url 'accounts:admin_dashboard' %}" class="btn btn-xs btn-info w-full transition-link truncate text-xs">
              📊 管理ダッシュボード
            </a>
            <a href="{% url 'admin:index' %}" class="btn btn-xs btn-warning w-full transition-link truncate text-xs" target="_blank">
              🔧 Django管理画面
            </a>
            {% endif %}
          </div>
        </div>
      {% endif %}

      <div class="flex-grow overflow-hidden">
        <nav class="bg-base-100 p-3 rounded-lg mb-4 overflow-hidden">
          <h3 class="text-sm font-semibold mb-3 text-base-content flex items-center truncate">
            📱 <span class="ml-2 truncate">メニュー</span>
          </h3>
          <ul class="menu text-sm space-y-1 overflow-hidden">
            <li><a href="/" class="rounded-lg hover:bg-primary hover:text-primary-content transition-colors text-base-content transition-link truncate text-xs py-2">🏠 ホーム</a></li>
            <li><label for="modal-post" class="cursor-pointer rounded-lg hover:bg-primary hover:text-primary-content transition-colors text-base-content truncate text-xs py-2">📝 新規投稿</label></li>
            <li><a class="rounded-lg hover:bg-primary hover:text-primary-content transition-colors text-base-content truncate text-xs py-2">📅 カレンダー</a></li>
            <li><a class="rounded-lg hover:bg-primary hover:text-primary-content transition-colors text-base-content truncate text-xs py-2">📁 ファイル置き場</a></li>
            <li><a class="rounded-lg hover:bg-primary hover:text-primary-content transition-colors text-base-content truncate text-xs py-2">✅ Todoリスト</a></li>
            <li><a href="{% url 'accounts:profile_settings' %}" class="rounded-lg hover:bg-primary hover:text-primary-content transition-colors text-base-content transition-link truncate text-xs py-2">⚙️ アカウント設定</a></li>
            {% if user.is_staff or user.is_superuser or user.profile.can_manage_users %}
            <li><a href="{% url 'accounts:admin_dashboard' %}" class="rounded-lg hover:bg-info hover:text-info-content transition-colors text-info transition-link truncate text-xs py-2">📊 管理ダッシュボード</a></li>
            {% endif %}
            <li><a href="{% url 'accounts:logout' %}" class="rounded-lg hover:bg-error hover:text-error-content transition-colors text-error transition-link truncate text-xs py-2">🚪 ログアウト</a></li>
          </ul>
        </nav>
      </div>
        
      <!-- フィラー（余白を埋めて背景を下まで伸ばす） -->
      <div class="flex-grow"></div>
      </div>
    </aside>
    {% endif %}

    <!-- メインコンテンツ -->
    <main id="main-content" class="flex-1 max-w-3xl mx-auto p-6 rounded-xl shadow-lg overflow-hidden main-content bg-base-100 border border-base-content/10">
      {% block page_title %}
        <!-- デフォルトではページタイトルを表示しない -->
      {% endblock %}
      {% block content %}{% endblock %}
    </main>

    {% if user.is_authenticated %}
    <!-- 右サイドバー（ログイン時のみ表示） -->
    <aside data-sidebar="right" class="bg-base-300 p-4 rounded-lg shadow-lg sidebar-sticky sidebar-right sidebar-full-height hidden md:block resizable-sidebar" style="min-width: 240px; max-width: 600px;">
      <!-- リサイズハンドル（左側） -->
      <div class="resize-handle resize-handle-left" data-sidebar="right"></div>
      <div class="h-full flex flex-col">
        <div class="bg-base-100 p-3 rounded-lg mb-4">
          <h2 class="text-lg font-bold mb-3 text-success flex items-center">
            🟢 <span class="ml-2">オンライン</span>
          </h2>
          <div id="online-users-loading" class="text-sm text-base-content/60 text-center">
            <span class="loading loading-spinner loading-sm mr-2"></span>
            読み込み中...
          </div>
          <ul id="online-users-list" class="space-y-2 hidden">
            <!-- オンラインユーザーがここに動的に追加されます -->
          </ul>
          <div id="online-users-error" class="hidden text-sm text-error text-center">
            オンラインユーザー情報を取得できませんでした
            <button id="online-users-retry" class="btn btn-xs btn-outline btn-primary ml-2">再試行</button>
          </div>
        </div>
        
        <div class="bg-base-100 p-3 rounded-lg mb-4">
          <h2 class="text-lg font-bold mb-3 text-warning flex items-center">
            🔔 <span class="ml-2">通知</span>
          </h2>
          <div id="notifications-loading" class="text-sm text-base-content/60 text-center">
            <span class="loading loading-spinner loading-sm mr-2"></span>
            読み込み中...
          </div>
          <ul id="notifications-list" class="space-y-2 text-sm hidden">
            <!-- 通知がここに動的に追加されます -->
          </ul>
          <div id="notifications-error" class="hidden text-sm text-error text-center">
            通知情報を取得できませんでした
            <button id="notifications-retry" class="btn btn-xs btn-outline btn-primary ml-2">再試行</button>
          </div>
        </div>
        
        <!-- デジタル時計 -->
        <div class="bg-base-100 p-3 rounded-lg mb-4 text-center">
          <h3 class="text-sm font-semibold mb-3 flex items-center justify-center text-accent">
            🕐 <span class="ml-2">現在時刻</span>
          </h3>
          <div id="digital-clock" class="text-xl font-mono font-bold text-primary mb-1">
            --:--:--
          </div>
          <div id="digital-date" class="text-sm text-base-content/70">
            ----年--月--日
          </div>
        </div>

        <!-- 天気情報 -->
        <div class="bg-base-100 p-3 rounded-lg mb-4">
          <h3 class="text-sm font-semibold mb-3 flex items-center text-info">
            🌤️ <span class="ml-2">天気情報</span>
          </h3>
          <div id="weather-content">
            <div id="weather-loading" class="text-sm text-base-content/60 text-center">
              <span class="loading loading-spinner loading-sm mr-2"></span>
              位置情報を取得中...
            </div>
            <div id="weather-data" class="hidden">
              <div class="text-sm">
                <div id="weather-location" class="font-medium text-primary mb-1"></div>
                <div id="weather-area" class="text-xs text-base-content/70 mb-2"></div>
                <div id="weather-desc" class="text-base-content/80 mb-2 p-2 bg-base-100/50 rounded"></div>
                <div id="weather-temp" class="text-lg font-bold text-accent"></div>
                <div id="weather-time" class="text-xs text-base-content/60 mt-1"></div>
              </div>
            </div>
            <div id="weather-error" class="hidden text-sm text-error">
              天気情報を取得できませんでした
              <button id="weather-retry" class="btn btn-xs btn-outline btn-primary ml-2">再試行</button>
            </div>
          </div>
        </div>
        
        <!-- デバッグ用ボタン（開発時のみ） -->
        <div class="bg-base-100 p-3 rounded-lg mb-4">
          <h3 class="text-sm font-semibold mb-3 flex items-center text-warning">
            🔧 <span class="ml-2">デバッグ</span>
                <span class="text-xs text-base-content/60 ml-2">(開発者向け)</span>
            </h3>
          <button onclick="pageTransition.test()" class="btn btn-xs btn-outline btn-warning w-full">
            遷移テスト
          </button>
        </div>
        
        <!-- フィラー（余白を埋めて背景を下まで伸ばす） -->
        <div class="flex-grow"></div>
      </div>
    </aside>
    {% endif %}
  </div>

  <!-- 画像ビューワー -->
  <div class="image-viewer" id="imageViewer">
    <button class="close-btn" onclick="closeImageViewer()">×</button>
    <img id="viewerImage" src="" alt="拡大画像" />
  </div>

  <!-- ログインモーダル -->
  <input type="checkbox" id="modal-login" class="modal-toggle" {% if form.errors %}checked{% endif %} />
  <div class="modal">
    <div id="modal-loginBox" class="modal-box relative max-w-md w-full">
      <label for="modal-login" class="btn btn-sm btn-circle absolute right-2 top-2">✕</label>
      <h3 class="font-bold text-lg drag-handle cursor-move mb-4">ログイン</h3>
      <form method="post" action="{% url 'accounts:login' %}" class="space-y-4">
        {% csrf_token %}
        <input type="text" name="username" placeholder="ユーザー名" class="input input-bordered w-full" required />
        <input type="password" name="password" placeholder="パスワード" class="input input-bordered w-full" required />
        <button type="submit" class="btn btn-primary w-full">ログイン</button>
        {% if form.errors %}
          <p class="text-red-500">ユーザー名またはパスワードが違います。</p>
        {% endif %}
      </form>
    </div>
  </div>

  <!-- 投稿モーダル -->
  <input type="checkbox" id="modal-post" class="modal-toggle" />
  <div class="modal">
    <div id="postModalBox" class="modal-box relative w-[90vw] max-w-4xl h-[80vh] overflow-hidden">
      <label for="modal-post" class="btn btn-sm btn-circle absolute right-2 top-2">✕</label>
      <h3 class="font-bold text-lg drag-handle cursor-move mb-4">✏️ 新規投稿</h3>
      
      <form method="post" action="{% url 'posts:create' %}" enctype="multipart/form-data"
            class="flex flex-col h-[calc(100%-4rem)] space-y-4">
        {% csrf_token %}
        
        <!-- テキストエリア -->
        <div class="form-control flex-grow">
          <label class="label">
            <span class="label-text font-semibold">投稿内容</span>
            <span class="label-text-alt" id="post-char-count">0 / 1000文字</span>
          </label>
          <div class="relative flex-grow">
            <textarea name="content" id="post-content" placeholder="進捗とか雑談とか" 
                      class="textarea textarea-bordered w-full h-full resize-none text-base leading-relaxed p-4" 
                      maxlength="1000" required></textarea>
            <div class="absolute bottom-3 right-3 text-xs text-base-content/40">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
              </svg>
            </div>
          </div>
        </div>
        
        <!-- 画像アップロードエリア -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-semibold">画像・ファイルを添付（任意）</span>
          </label>
          
          <div class="relative">
            <input type="file" name="image" id="post-image-input" class="hidden" accept="image/*" />
            
            <!-- プレビューエリア（画像選択後に表示） -->
            <div id="image-preview" class="hidden mb-4 p-4 bg-base-200 rounded-lg border border-base-content/10">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-success">💾 ファイルが添付されました</span>
                <button type="button" id="remove-image" class="btn btn-xs btn-error btn-outline">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1H8a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                  削除
                </button>
              </div>
              <div class="flex items-center space-x-3">
                <img id="preview-image" src="" alt="プレビュー" class="w-16 h-16 object-cover rounded-lg" />
                <div>
                  <p id="image-name" class="text-sm font-medium"></p>
                  <p id="image-size" class="text-xs text-base-content/60"></p>
                </div>
              </div>
            </div>
            
            <!-- ドラッグ&ドロップエリア -->
            <div id="post-drop-zone" class="border-2 border-dashed border-base-content/20 rounded-lg p-8 text-center hover:border-primary/60 hover:bg-primary/5 transition-all duration-300 cursor-pointer group" onclick="document.getElementById('post-image-input').click()">
              <div class="transition-all duration-300 group-hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-base-content/30 group-hover:text-primary/70 mb-3 transition-colors duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <p class="text-base-content/60 mb-1 font-medium group-hover:text-primary/80 transition-colors">クリックして画像やファイルを選択</p>
                <p class="text-sm text-base-content/40 group-hover:text-primary/60 transition-colors">またはここにドラッグ&ドロップ</p>
              </div>
              
              <!-- ドラッグ中のオーバーレイ -->
              <div id="post-drag-overlay" class="absolute inset-0 bg-primary/10 border-2 border-primary rounded-lg flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-200">
                <div class="text-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto text-primary mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                  </svg>
                  <p class="font-bold text-primary">ここにドロップ！</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 送信ボタン -->
        <div class="form-control pt-4">
          <button type="submit" id="post-submit-btn" class="btn btn-primary w-full">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
            </svg>
            投稿する
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 最小限のコア機能JavaScript -->
  <script>
    // ページ初期表示制御（フラッシュ防止・ガクガク防止）
    window.addEventListener('DOMContentLoaded', function() {
      document.documentElement.style.transition = 'opacity 0.1s ease-out';
      document.documentElement.style.visibility = 'visible';
      document.documentElement.style.opacity = '1';
      document.body.style.visibility = 'visible';
      document.body.style.opacity = '1';
    });

    // モバイルメニュー開閉（モバイル時のみ）
    document.addEventListener('DOMContentLoaded', function() {
      const mobileMenuBtn = document.getElementById('mobile-menu-btn');
      const mobileCloseBtn = document.getElementById('mobile-close-btn');
      const mobileSidebar = document.getElementById('mobile-sidebar');
      const sidebarBackdrop = document.getElementById('sidebar-backdrop');

      function openMobileSidebar() {
        if (mobileSidebar && window.innerWidth < 768) {
          mobileSidebar.classList.remove('hidden');
          mobileSidebar.style.position = 'fixed';
          mobileSidebar.style.zIndex = '50';
        }
        if (sidebarBackdrop) sidebarBackdrop.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function closeMobileSidebar() {
        if (mobileSidebar && window.innerWidth < 768) {
          mobileSidebar.classList.add('hidden');
          mobileSidebar.style.position = '';
          mobileSidebar.style.zIndex = '';
        }
        if (sidebarBackdrop) sidebarBackdrop.classList.remove('active');
        document.body.style.overflow = 'auto';
      }

      if (mobileMenuBtn) mobileMenuBtn.addEventListener('click', openMobileSidebar);
      if (mobileCloseBtn) mobileCloseBtn.addEventListener('click', closeMobileSidebar);
      if (sidebarBackdrop) sidebarBackdrop.addEventListener('click', closeMobileSidebar);
    });

    // 投稿削除機能（管理者・本人のみ）
    async function deletePost(postId) {
      if (!confirm('この投稿を削除しますか？この操作は取り消せません。')) {
        return;
      }
      
      try {
        const response = await fetch(`/posts/delete/${postId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken'),
          },
        });
        
        if (response.ok) {
          if (window.showPageTransition) {
            window.showPageTransition();
          }
          location.reload();
        } else {
          alert('削除に失敗しました');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('エラーが発生しました');
      }
    }

    // いいねボタン機能
    async function likePost(postId) {
      try {
        const response = await fetch(`/posts/like/${postId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({}),
        });

        if (!response.ok) throw new Error('Network response was not ok');
        const data = await response.json();

        const button = document.querySelector(`[data-post-id="${postId}"]`);
        if (button) {
          button.querySelector('.like-count').textContent = data.like_count;
          
          if (data.liked) {
            button.classList.add('btn-primary');
            button.classList.remove('btn-outline');
          } else {
            button.classList.remove('btn-primary');
            button.classList.add('btn-outline');
          }
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // CSRFトークン取得（ユーティリティ関数）
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          cookie = cookie.trim();
          if (cookie.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  </script>

  <!-- KokkoSofter JavaScript モジュール -->
  <script src="{% static 'js/page-transitions.js' %}"></script>
  <script src="{% static 'js/theme.js' %}"></script>
  <script src="{% static 'js/clock.js' %}"></script>
  <script src="{% static 'js/weather.js' %}"></script>
  <script src="{% static 'js/sidebar.js' %}"></script>
  <script src="{% static 'js/sidebar-resizer.js' %}"></script>
  <script src="{% static 'js/image-viewer.js' %}"></script>
  <script src="{% static 'js/post-form.js' %}"></script>

</body>
</html>
</html>
</html>
</html>
