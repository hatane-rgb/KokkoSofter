{% extends 'base.html' %}

{% block title %}アカウント設定 - KokkoSofter{% endblock %}

{% block page_title %}
<h1 class="text-2xl font-bold mb-4 text-base-content">アカウント設定</h1>
{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
  
  <!-- メッセージ表示 -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-success mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span>{{ message }}</span>
      </div>
    {% endfor %}
  {% endif %}

  <form method="post" enctype="multipart/form-data" class="space-y-6">
    {% csrf_token %}
    
    <!-- プロフィール画像セクション -->
    <div class="card bg-base-300 shadow-lg">
      <div class="card-body">
        <h2 class="card-title mb-6 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
          プロフィール画像
        </h2>
        
        <div class="flex flex-col lg:flex-row items-center lg:items-start space-y-6 lg:space-y-0 lg:space-x-8">
          <!-- 現在のアバター表示 -->
          <div class="flex flex-col items-center">
            <div class="avatar relative group">
              <div class="w-36 rounded-full ring-4 ring-primary ring-offset-4 ring-offset-base-100 shadow-xl hover:shadow-2xl transition-all duration-300 hover:scale-105">
                <img src="{{ profile.get_avatar_url }}" alt="現在のアバター" class="rounded-full" />
              </div>
              <!-- プレビューオーバーレイ -->
              <div class="absolute inset-0 bg-black/40 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
                <div class="text-white text-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mx-auto mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                  </svg>
                  <p class="text-xs font-medium">プレビュー</p>
                </div>
              </div>
            </div>
            <p class="text-sm text-base-content/70 mt-4 text-center font-medium">現在のプロフィール画像</p>
          </div>
          
          <!-- アップロードエリア -->
          <div class="flex-1 w-full">
            <div class="form-control w-full">
              <label class="label">
                <span class="label-text font-semibold">新しい画像をアップロード</span>
              </label>
              
              <!-- カスタムファイルアップロードエリア -->
              <div class="relative">
                <div style="display: none;">{{ profile_form.avatar }}</div>
                <div id="drop-zone" class="border-2 border-dashed border-base-content/20 rounded-xl p-10 text-center hover:border-primary/60 hover:bg-primary/5 transition-all duration-300 cursor-pointer group" onclick="document.querySelector('input[type=file]').click()">
                  <div class="transition-all duration-300 group-hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-base-content/30 group-hover:text-primary/70 mb-4 transition-colors duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <p class="text-base-content/70 mb-2 font-medium group-hover:text-primary/80 transition-colors">クリックして画像を選択</p>
                    <p class="text-sm text-base-content/50 group-hover:text-primary/60 transition-colors">または画像をここにドラッグ&ドロップ</p>
                  </div>
                  <!-- ドラッグ中のオーバーレイ -->
                  <div id="drag-overlay" class="absolute inset-0 bg-primary/10 border-2 border-primary rounded-xl flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-200">
                    <div class="text-center">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-primary mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                      </svg>
                      <p class="font-bold text-primary">ここに画像をドロップ</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <label class="label">
                <span class="label-text-alt flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  JPG, PNG, GIF形式 / 最大5MB
                </span>
              </label>
              
              <!-- 現在のファイル削除オプション -->
              {% if profile.avatar %}
                <div class="mt-4 p-4 bg-base-200 rounded-lg border border-base-content/10">
                  <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                      <span class="text-sm font-medium">アップロード済み画像</span>
                    </div>
                    <span class="text-xs text-base-content/60">{{ profile.avatar.name|slice:"8:" }}</span>
                  </div>
                  
                  <label class="cursor-pointer label flex items-center justify-start p-2 hover:bg-base-300/50 rounded transition-colors">
                    <input type="checkbox" name="avatar-clear" id="id_avatar-clear" class="checkbox checkbox-sm checkbox-error mr-3">
                    <div class="flex items-center">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-error" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1H8a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                      <span class="label-text text-sm">現在の画像を削除してデフォルトに戻す</span>
                    </div>
                  </label>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 基本情報セクション -->
    <div class="card bg-base-300 shadow-lg">
      <div class="card-body">
        <h2 class="card-title mb-6 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2" />
          </svg>
          基本情報
        </h2>
        
        <div class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-control">
              <label class="label">
                <span class="label-text font-semibold">{{ user_form.first_name.label }}</span>
              </label>
              {{ user_form.first_name }}
            </div>
            
            <div class="form-control">
              <label class="label">
                <span class="label-text font-semibold">{{ user_form.last_name.label }}</span>
              </label>
              {{ user_form.last_name }}
            </div>
          </div>
          
          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">{{ user_form.email.label }}</span>
            </label>
            {{ user_form.email }}
          </div>
          
          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">ユーザー名</span>
            </label>
            <div class="relative">
              <input type="text" value="{{ user.username }}" class="input input-bordered pr-10" disabled />
              <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-base-content/40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
              </div>
            </div>
            <label class="label">
              <span class="label-text-alt flex items-center text-base-content/60">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                ユーザー名の変更をご希望の場合は管理者までお問い合わせください
              </span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- 現在の役職表示（読み取り専用） -->
    <div class="card bg-base-300 shadow-lg">
      <div class="card-body">
        <h2 class="card-title mb-6 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
          </svg>
          現在の役職
        </h2>
        
        <div class="flex items-center justify-between p-4 bg-base-200 rounded-lg">
          <div class="flex items-center space-x-3">
            <span class="badge {{ profile.get_role_badge_class }} badge-lg">
              {{ profile.get_role_display_with_icon }}
            </span>
          </div>
          <div class="text-sm text-base-content/60">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            ロールの変更は管理者にお問い合わせください
          </div>
        </div>
      </div>
    </div>

    <!-- 自己紹介セクション -->
    <div class="card bg-base-300 shadow-lg">
      <div class="card-body">
        <h2 class="card-title mb-6 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
          自己紹介
        </h2>
        
        <div class="form-control">
          <label class="label">
            <span class="label-text font-semibold">{{ profile_form.bio.label }}</span>
            <span class="label-text-alt" id="char-count">0 / 500文字</span>
          </label>
          <div class="relative">
            {{ profile_form.bio }}
            <div class="absolute bottom-3 right-3 text-xs text-base-content/40" id="char-indicator">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
              </svg>
            </div>
          </div>
          <label class="label">
            <span class="label-text-alt text-base-content/60">
              あなたについて教えてください！スキルや趣味など何でも
            </span>
          </label>
        </div>
      </div>
    </div>

    <!-- 保存ボタン -->
    <div class="card bg-base-300 shadow-lg">
      <div class="card-body">
        <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 sm:space-x-4">
          <div class="flex items-center text-sm text-base-content/60">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            変更内容は保存するまで反映されません
          </div>
          <div class="flex space-x-4">
            <a href="/" class="btn btn-outline">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
              キャンセル
            </a>
            <button type="submit" class="btn btn-primary">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
              </svg>
              設定を保存
            </button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // 文字数カウンター
  const bioTextarea = document.querySelector('textarea[name="bio"]');
  const charCount = document.getElementById('char-count');
  
  if (bioTextarea && charCount) {
    function updateCharCount() {
      const currentLength = bioTextarea.value.length;
      const maxLength = 500;
      
      charCount.textContent = `${currentLength} / ${maxLength}文字`;
      
      // 文字数が上限に近づいたら色を変更
      if (currentLength > maxLength * 0.9) {
        charCount.classList.add('text-warning');
      } else {
        charCount.classList.remove('text-warning');
      }
      
      if (currentLength > maxLength) {
        charCount.classList.add('text-error');
        charCount.classList.remove('text-warning');
      } else {
        charCount.classList.remove('text-error');
      }
    }
    
    // 初期値設定
    updateCharCount();
    
    // リアルタイム更新
    bioTextarea.addEventListener('input', updateCharCount);
  }
  
  // ファイルアップロードのドラッグ&ドロップ
  const uploadArea = document.querySelector('#drop-zone');
  const dragOverlay = document.querySelector('#drag-overlay');
  const fileInput = document.querySelector('input[type="file"]');
  
  if (uploadArea && fileInput) {
    let dragCounter = 0;
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, preventDefaults, false);
      document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    uploadArea.addEventListener('dragenter', function(e) {
      dragCounter++;
      showDragOverlay();
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
      dragCounter--;
      if (dragCounter <= 0) {
        hideDragOverlay();
      }
    });
    
    uploadArea.addEventListener('dragover', function(e) {
      showDragOverlay();
    });
    
    uploadArea.addEventListener('drop', function(e) {
      dragCounter = 0;
      hideDragOverlay();
      handleDrop(e);
    });
    
    function showDragOverlay() {
      if (dragOverlay) {
        dragOverlay.style.opacity = '1';
      }
    }
    
    function hideDragOverlay() {
      if (dragOverlay) {
        dragOverlay.style.opacity = '0';
      }
    }
    
    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      
      if (files.length > 0) {
        const file = files[0];
        
        // 画像ファイルかチェック
        if (file.type.startsWith('image/')) {
          fileInput.files = files;
          
          // ファイル名を表示
          const fileName = file.name;
          const fileSize = (file.size / 1024 / 1024).toFixed(2);
          
          // アップロードエリアの表示を更新
          const messageP = uploadArea.querySelector('p');
          if (messageP) {
            messageP.innerHTML = `<span class="text-success font-medium">✓ ${fileName}</span><br><span class="text-xs text-base-content/60">${fileSize}MB</span>`;
          }
          
          // プレビューを表示（オプション）
          const reader = new FileReader();
          reader.onload = function(e) {
            const currentAvatar = document.querySelector('.avatar img');
            if (currentAvatar) {
              currentAvatar.src = e.target.result;
            }
          };
          reader.readAsDataURL(file);
          
        } else {
          alert('画像ファイルをお願いします！（JPG, PNG, GIF）');
        }
      }
    }
    
    // ファイル入力の変更監視
    fileInput.addEventListener('change', function(e) {
      if (e.target.files.length > 0) {
        const file = e.target.files[0];
        const fileName = file.name;
        const fileSize = (file.size / 1024 / 1024).toFixed(2);
        
        // アップロードエリアの表示を更新
        const messageP = uploadArea.querySelector('p');
        if (messageP) {
          messageP.innerHTML = `<span class="text-success font-medium">✓ ${fileName}</span><br><span class="text-xs text-base-content/60">${fileSize}MB</span>`;
        }
        
        // プレビューを表示
        const reader = new FileReader();
        reader.onload = function(e) {
          const currentAvatar = document.querySelector('.avatar img');
          if (currentAvatar) {
            currentAvatar.src = e.target.result;
          }
        };
        reader.readAsDataURL(file);
      }
    });
  }
});
</script>
{% endblock %}
